{% extends "lots/base.html" %}
{% load i18n %}
{% load styled_forms %}
{% load lot_tags %}

{% block body %}
<div class="t">
    {% lot_nav request.user %}
    <div class="lot-wrap">
        <h1>{% trans "Edit Lot" %}</h1>

        <form method="post" action="" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="map-wrap">
            <div class="map-photo">
                <canvas height="{{ map|height_for_width:900 }}" width="900" ></canvas>
            </div>
            <p class="map-title">
                <a title="Opens in new window" target="_blank" 
                href="{% url lots.map_detail map.slug %}">
                {{ map.name }}</a>
            </p>
        </div>

        <div class="reset-drawing" style="display:none;"><a href="javascript:;">
            Reset area on map</a></div>

        <div class="forms">
            {{ formset.management_form }}
            <div id="lines-formset"></div>
            {{ photo_formset }}
            {{ form|styled_form }}
            <input type="submit" value="Submit">
        </div>
        </form>
    </div>
    <div id="line-hidden">
        <input type="text" name="lines-0-x1" class="x1" id="id_lines-0-x1" />
        <input type="text" name="lines-0-y1" class="y1" id="id_lines-0-y1" />
        <input type="text" name="lines-0-x2" class="x2" id="id_lines-0-x2" />
        <input type="text" name="lines-0-y2" class="y2" id="id_lines-0-y2" />
	    <input type="hidden" name="lines-0-id" id="id_lines-0-id" />
	</div>
</div>

{% endblock body %}

{% block extra_body %}
{{ block.super }}
<script type="text/javascript" src="{{ STATIC_URL }}js/jcanvas.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/slug.js"></script>
<script type="text/javascript">
    var slugit = new Slugify({
        input_element : 'input#id_name',
        slug_element : 'input#id_slug',
        submit_element : 'input[type="submit"]',
        help: false,
        limit : 150
    });
</script>
<script type="text/javascript">
{% include "lots/media/js/maps.js" %}
// initialize map image
$(document).ready(function(){

    var default_area = function(){
        {% for line in lot.line_set.all %}
        $("canvas").drawLine({
            strokeStyle: "#AAA",
            strokeWidth: 10,
            strokeCap: "round",
            strokeJoin: "miter",
            x1: {{ line.x1 }}, y1: {{ line.y1 }},
            x2: {{ line.x2 }}, y2: {{ line.y2 }},
        });
        {% endfor %}
    };

    var draw_default = function(){
        $("canvas").drawImage({
            source: "{{ lot.map.get_absolute_url }}",
            x: 0, y: 0,
            width: 900,
            fromCenter: false,
            load: default_area,
        });
    };

    draw_default();

    $('.reset-drawing').click(function(){
        $(this).hide();  // hide reset link
        $('#lines-formset').children().remove();  // remove form fields
        draw_default();  // draw original map on canvas

        $('#id_lines-TOTAL_FORMS').val(0);  // reset # of forms
        addLine('lines', {});  // set form field 0

        prev_x = null;  // reset previous
        prev_y = null;  // coordinates
    });

    $('canvas').click(function(){
        var lines = $('#id_lines-TOTAL_FORMS').val();
        if(lines > 1) $('.reset-drawing').show();
    });

});
</script>
{% endblock %}
